# SafeG-Auto 仕様書 version 1.2


# このドキュメントについて

SafeG-Auto の仕様について説明したものである．

# 仕様策定方針

- 実装が複雑化しない仕様とする
    - ハイパーバイザーはシステムの最高の安全度水準で開発する必要があるため，可能な限り規模を小さくして，シンプルな実装とする． 

# コンフィギュレーション

仮想マシンの定義やスケジューリング等の設定は，設計時のみに指定することが可能である（静的コンフィギュレーション）．

コンフィギュレーション方法はyaml形式で記述し，C言語のヘッダーファイル（hv_cfg.h）及びソースコード（hv_cfg.c）を生成する．

コンフィギュレーション方法の詳細については，configurator.md を参照のこと．


# 処理単位

ハイパーバイザーを用いたシステムでは，ユーザーの処理（関数）は，ゲスト処理とユーザーホスト処理に分類される．

ゲスト処理は，プロセッサのゲストモードで実行される処理であり，仮想マシン内で実行される．

ユーザーホスト処理はプロセッサのホストモードで実行される処理であり，ハイパーバイザーから呼び出される各種のハンドラやホストモードで動作する処理単位の本体として実行される．

ハイパーバイザーで扱う処理単位の一覧を以下に示す．

- ゲスト処理
  - 仮想マシン
- ユーザーホスト処理
  - HVタイムウィンドウ処理
  - HVアイドル処理
  - HV割込みハンドラ
  - HVサービル関数
  -	HVフック関数
  - HVユーザー起動関数

## 仮想マシン

仮想マシンはゲストモードで実行される処理単位である．

仮想マシンはシステム上に複数作成することが可能であり，各仮想マシンオブジェクトはIDで識別する．なお，IDはGPIDとは独立である．

1つの仮想マシンオブジェクトは，RH850の1つのコアの各種コンテキストを持つ．

### コンフィギュレーション

仮想マシンオブジェクト毎に以下のパラメータを指定する．

- コアID
- リセットベクタ先頭アドレス
- GPID
- SPIDリスト
- 初期SPID
- メモリ情報
	- アクセス可能なメモリの上位アドレス・下位アドレス・アクセス属性
	- 個数は，HV管理としたMPUのエントリ数が上限となる
- バインドする割込みの割込番号のリスト

### 初回実行

仮想マシンは実行が開始されると，リセットベクタから処理が開始される．それ以降は中断した箇所から処理を再開する．

仮想マシンオブジェクトの初回実行時のコンテキストの状態は次の通りである．

- 汎用レジスタ
  - 不定値
- PC
  - 初期化情報で指定されたリセットベクタ先頭アドレス
- EBASE
  - 初期化情報で指定されたリセットベクタ先頭アドレス
- SPID
  - 初期化情報で指定された初期SPID
- SPIDLIT
  - 初期化情報で指定されたSPIDリスト
- MPM
  - ホスト管理のエントリによる保護の有効(GMPE=1)
- その他のリセット時の値が指定されているシステムレジスタ
  - リセット時の値
- その他のリセット時の値が指定されていないシステムレジスタ
  - 不定値

### 使用可能なコプロセッサ

コプロセッサは，FPUのみ使用することが可能である．

### MPU

MPUはホスト管理エントリで保護される．

ホスト管理エントリは，初期化情報のメモリ情報によりハイパーバイザーが仮想マシンオブジェクト実行時に設定される．

ゲスト管理のMPUエントリはサポートしない．

ホスト管理のMPUエントリで発生したMPU例外は，ホストモードで受け付ける．

### マルチコア環境

1つの仮想マシンオブジェクトは指定したコアと同じコアのタイムウィンドウにのみ割り付けることが可能である．言い換えると，1つの仮想マシンオブジェクトは，特定のコアでのみ実行される．

## HVタイムウィンドウ処理

HVタイムウィンドウ処理は，ホストモードでHVタイムウィンドウ内で実行される処理である．

RTOSにおけるタスクと同様に，独立したコンテキストを持ち，スタックは他のユーザーホスト処理と独立したものを使用する．

HVタイムウィンドウが開始されると実行され，HVタイムウィンドウの時間が経過すると中断され，次のHVタイムウィンドウで再開される．

### 初回実行

HVタイムウィンドウ処理の初回実行時は，ハイパーバイザーと同一バイナリにある以下の名前の関数から実行が開始される．

  void hv_twd(void)

HVタイムウィンドウ処理の初回実行時のコンテキストの状態は次の通りである．

- PSW : 以下のビット以外は全て0
  - EIMASK : 最低優先度
  - EBV    : 1(EBASE有効)
  - CU0    : 1(FPU有効)
- PLMR
  - 最低優先度  
- 汎用レジスタ
  - TP  : シンボル __tp
  - GP  : シンボル __gp
  - スタックポインタ : HVタイムウィンドウ処理のスタックの下限アドレス+4
- 割込みモード
  - 拡張割込みモード

PSWのEVB=0・FPUを無効や，割込みモードの変更をした場合の動作は保証しない．

### マルチコア環境

エントリとなる関数は同一であるが各コアでそれぞれの独立したコンテキストとして実行される．

実行タイミングは各コアで独立である．

### コンフィギュレーション

コア毎に以下のパラメータを指定する．

- スタックサイズ

## HVアイドル処理

HVアイドル処理は，アイドル区間内でホストモードで実行される処理である．

RTOSにおけるタスクと同様に，独立したコンテキストを持つ．

スタックは，HV割込みハンドラ/HVサービス関数/HVフック関数と共有する．

アイドル区間が開始されると実行され，次のシステム周期が開始されると中断され，次のアイドル区間で再開される．

### 初回実行

HVアイドル処理の初回実行時は，ハイパーバイザーと同一バイナリの以下の名前の関数から実行が開始される．

  void hv_idle(void)

HVアイドル処理の初回実行時のコンテキストの状態は次の通りである．

- PSW : 以下のビット以外は全て0
  - EIMASK : 最低優先度
  - EBV    : 1(EBASE有効)
  - CU0    : 1(FPU有効)
- PLMR
  - 最低優先度  
- その他レジスタ
  - TP  : __tp に設定 
  - GP  : __gp に設定
  - スタックポインタ : HVスタックのアドレスに設定
- 割込みモード
  - 拡張割込みモード

PSWのEVB=0・FPUを無効や，割込みモードの変更をした場合の動作は保証しない．

### VMの呼び出し

HVアイドル処理からサービスコールを呼び出すことで，アイドル区間内で特定のVMを実行することが可能である．

一度VMを呼び出すとそのアイドル区間では呼び出したVMが実行される．

次のシステム周期のアイドル区間が実行されると，サービコールからリターンする．

呼び出し可能なVMは同じコアに割り当てられたVMのみである．

### マルチコア環境

エントリとなる関数は同一であるが各コアでそれぞれの独立したコンテキストとして実行される．

実行タイミングは各コアで独立である．

## HV割込みハンドラ

HV割込みハンドラは，ホストにバインドした割り込みが発生した場合にホストモードで呼び出されるハンドラである．

スタックは，HVアイドル処理/HVサービス関数/HVフック関数と共有する．

HV割込みが発生するとハイパーバイザーを経由して登録されたHV割込みハンドラが呼び出される．

HV割込みハンドラは，割込み禁止状態で実行される．割込みを許可した場合は動作は保証しない．

### コンフィギュレーション

HV割込みハンドラ毎に以下のパラメータを指定する．

- 割込み番号
- 実行するコアID
- 割込み優先度
- 割込許可の初期状態
- 割込みハンドラアドレス

設定可能な優先度は，0から13の範囲である．

## HVサービス関数

HVサービス関数は，hvtrapを契機にホストモードで呼び出されるハンドラである．

スタックは，HVタイウィンドウ処理/HVアイドル処理/HVフック関数と共有する．

hvtrapが呼び出されると，ハイパーバイザーを経由して登録されたHV割込みハンドラが呼び出される．

HVサービス関数は，割込み禁止状態で実行される．

### コンフィギュレーション

HVサービス関数毎に以下のパラメータを指定する．

- HVサービス関数のアドレス

## HVフック関数

ハイパーバイザーの各種タイミングで呼び出される関数．

以下のフック関数が存在する．

- 起動時フック関数
  - HVの起動時に各種初期化が終了後，システム周期を開始する直前に呼び出される．
- システム周期フック関数
  - システム周期切替え時に呼び出される．
- タイムウィンドウ切替えフック関数
  - タイムウィンドウ切換え時に呼び出される．

HVフック関数は全ての割込みは禁止した状態で呼び出させる．HVフック関数で割込みを許可した場合の動作は保証しない．

## HVユーザー起動関数

システム起動時にスタートアップコードから，ハイパーバイザーの起動前に呼び出される関数．

HVユーザーメイン関数から，ハイパーバイザースタート関数を呼び出すことにより，ハイパーバイザーの動作が開始される．

# スケジューリング

## システム周期

時間保護を実現するため，スケジューリングはTDMAを用いる．

TDMAではシステム周期を指定し，システム周期内の時間を複数のタイムウィンドウに分割する．

タイムウィンドウ間には空白時間を入れることはできない．

ハイパーバイザーの初期化が終了した後，先頭のタイムウィンドウに割り付けられた処理を実行する．

先頭のタイムウィンドウの実行後，指定された時間経過したら次のタイムウィンドウに割り付けられた処理に切り替える．

全てのタイムウィンドウを実行したら，次のシステム周期の開始時刻までアイドル区間となる．

次のシステム周期の開始時刻になれば，再び先頭のタイムウィンドウに割り付けられた処理から実行を繰り返す．

システム周期とタイムウィンドウの長さはマイクロ秒で指定する．

システム周期を切り替えるハイパーバイザーの処理をシステム周期切換え処理と呼ぶ．

タイムウィンドウを切り替える処理やアイドル区間に切り替えるハイパーバイザーの処理をタイムウィンドウ切換え処理と呼ぶ．

![シングルプロセッサでのスケジューリング](./schedule_sp.jpg) 

### コンフィギュレーション

システム全体で次のパラメータを指定する．

- システム周期

### マルチコア環境

全てのコアでシステム周期は同一である．

タイムウィンドウの割付けは，コア毎に独立であり，1つのタイムウィンドウを複数のコアに割り付けることは出来ない．

ハイパーバイザー起動時に各種初期化終了後，コア間で同期した後にシステム周期をスタートさせる．

実行時のシステム周期のコア間の同期は実施しない．

![マルチプロセッサでのスケジューリング](./schedule_mp.jpg) 

マルチコアで動作するアプリケーションを実行した場合は，コアIDとバインドする割込みの割込み番号のリストは同じコンフィギュレーション情報で仮想マシンオブジェクトをコア数分用意すればよい．

同一のタイミングで各コアに割り付けた仮想マシンオブジェクトを実行したい場合は，同一タイミングで実行されるタイムウィンドウを各コアに割付け，そのコアに割り付けた仮想マシンオブジェクトを割り付ければよい．

![マルチVM](./schedule_multivm.jpg) 


## タイムウィンドウ

各タイムウィンドウは任意の時間長（タイムウィンドウ長）と実行する処理を指定することが可能である．

タイムウィンドウは次の2種類がある．

- VMタイムウィンドウ
  - ソフトウェアはゲストモードで実行される．
  - 仮想マシンを1個割り付けることが可能である．
  - 同一の仮想マシンを同一コアの複数のタイムウィンドウに割り付けることが可能である．

- HVタイムウィンドウ
  - ソフトウェアはホストモードで実行される．HVとバイナリを共有するHVタイムウィンドウ処理が実行される．
  - HVタイムウィンドウは複数個定義することが可能である．
  - 定義された全てのHVタイムウィンドウにおいて，同一のHVタイムウィンドウ処理が実行される．

### コンフィギュレーション

タイムウィンドウ毎に次のパラメータを指定する．

- 割付けコア
- 実行順序
- 実行時間
- 割付けVMのVMID
- タイムウィンドウトリガ割込の割込み番号(オプション)
- タイムウィンドウトリガ割込の割込み周期(オプション)

割付けVMのVMIDには，HVタイムウィンドウの場合は0を指定する．

## アイドル区間とHVアイドル処理

システム周期の最後にはタイムウィンドウを割り付けない区間を設ける（アイドル区間）．
この区間ではホストモードでHVアイドル処理が実行される．

## 各処理単位が消費する時間

各処理単位は実行されると，次に割り当てられた時間（バジェット）を消費する．

| 処理単位                |  対象
| -------                 | -----------
| 仮想マシン              | 割り付けられたVMタイムウィンドウ
| HVタイムウィンドウ処理  | HVタイムウィンドウ
| HVアイドル処理          | アイドル区間
| HV割込みハンドラ        | アイドル区間
| HVサービス関数          | 呼び出した仮想マシンが実行されているVMタイムウィンドウ．ただし，VMタイムウィンドウの終了時刻を超過した場合はアイドル区間
| HVフック関数            | アイドル区間

## 処理優先度

各処理の処理優先度は次の通りである．

|  優先度  |  処理単位           
| -------- | ------------------- 
|  高      |  HVサービス関数/HV割込みハンドラ/HVフック関数/システム周期切換え処理/タイムウィンドウ切換え処理
|  低      |  仮想マシン/HVタイムウィンドウ処理/HVアイドル処理

# システム動作モード

システム周期内へのタイムウィンドウへの割り付けはシステム動作モード（system operating mode）毎に設定することができる．

ある時点のシステム動作モードを現在のシステム動作モードと呼ぶ．

システム動作モードは，システム動作モードIDと呼ぶ1から始まるID番号によって識別する．

システム起動時のシステム動作モードは，起動時にstartHV()の引数で指定する．

システム動作モードはユーザーホスト処理向けサービス（ChangeSytemOperationMode()）により変更することが可能である．

ChangeSytemOperationMode()により指定されたシステム動作モードは，次のシステム周期から現在のシステム動作モードに反映される．具体的には，システム周期の切換え処理を最初に行ったプロセッサによって切り換えられる．そのため，他のプロセッサでは，一時的に，切換え前のシステム動作モードで実行している状況が生じる

現在のシステム動作モードはシステムで共通である．すなわち，現在のシステム動作モードを変更すると全てのコアのタイムウィンドウ割り付けが変更される．


# 割込み

割込みは，仮想マシンに割り付けたVM割込みと，ホストに割り付けたHV割込みの2種類に分類できる．

コンフィギュレーション時にVMに割り付ける割込みを指定する．指定しない割込みはHV割込みとなる．

VM割込みは，割り付けた仮想マシンのタイムウィンドウが実行されており，仮想マシンの状態が割込み受付状態であれば，仮想マシン内で受け付けられる．

ホストモードでは拡張割込みモードを有効にして動作する．

![割込み](./int.jpg)

## マルチコア環境

マルチコア環境においては，INTC2の割込みは次の様にコアに割り付けられる．

- VM割込み
  - 割り付けたVMが実行されるコアに対して割込みを発生させる．
- HV割込み
  - HV割込み定義時に指定したコアに対して割込みを発生させる．

# 例外処理

例外処理は，HVで発生した例外とVMで例外発生した例外について分けられる．

## HVで発生する例外

HVで発生する例外に関しては，FE/EI例外毎にユーザー例外ハンドラを呼び出す．

### FE例外ユーザー例外ハンドラ

FE例外が発生した場合は以下の例外ハンドラを呼び出す

	void hv_fe_handler(HVEXC_INFO *pHvexcInfo)

pHvexcInfo はHVで発生したFE例外の例外情報が渡される

### EI例外ユーザー例外ハンドラ

EI例外が発生した場合は以下の例外ハンドラを呼び出す

	void hv_ei_handler(HVEXC_INFO *pHvexcInfo)

pHvexcInfo はHVで発生したEI例外の例外情報が渡される

## HVで発生した例外の例外情報（HVEXC_INFO）

それぞれの例外の引数として渡される，HVEXC_INFO  は構造体となっており，そのメンバーはは次の通りである．

	uint32 cause;   /* 例外要因 */
	uint32 pc;      /* pc */
	uint32 psw;     /* psw */
	uint32 regbase; /* レジスタの保存先のベースアドレス */

regbaseには例外発生時の各種レジスタが保存されている領域であり，以下のオフセットによりアクセス可能である．


|  レジスタ名 |  オフセットマクロ名
| ----------- | ------------------- 
|  FPSR       |  HVEXC_REGBASE_FPSR 
|  R1         |  HVEXC_REGBASE_R1   
|  R2         |  HVEXC_REGBASE_R2   
|  R3(SP)     |  HVEXC_REGBASE_SP   
|  R4         |  HVEXC_REGBASE_R4   
|  R5         |  HVEXC_REGBASE_R5   
|  R6         |  HVEXC_REGBASE_R6   
|  R7         |  HVEXC_REGBASE_R7   
|  R8         |  HVEXC_REGBASE_R8   
|  R9         |  HVEXC_REGBASE_R9   
|  R10        |  HVEXC_REGBASE_R10  
|  R11        |  HVEXC_REGBASE_R11  
|  R12        |  HVEXC_REGBASE_R12  
|  R13        |  HVEXC_REGBASE_R13  
|  R14        |  HVEXC_REGBASE_R14  
|  R15        |  HVEXC_REGBASE_R15  
|  R16        |  HVEXC_REGBASE_R16  
|  R17        |  HVEXC_REGBASE_R17  
|  R18        |  HVEXC_REGBASE_R18  
|  R19        |  HVEXC_REGBASE_R19  
|  R20        |  HVEXC_REGBASE_R20  
|  R21        |  HVEXC_REGBASE_R21  
|  R22        |  HVEXC_REGBASE_R22  
|  R23        |  HVEXC_REGBASE_R23  
|  R24        |  HVEXC_REGBASE_R24  
|  R25        |  HVEXC_REGBASE_R25  
|  R26        |  HVEXC_REGBASE_R26  
|  R27        |  HVEXC_REGBASE_R27  
|  R28        |  HVEXC_REGBASE_R28  
|  R29        |  HVEXC_REGBASE_R29  
|  R30        |  HVEXC_REGBASE_R30  
|  R31        |  HVEXC_REGBASE_R31  


## VMで発生する例外

VMで発生する例外のうち，以下の例外以外はVM内で処理する

	MIP/MDP : ホスト定義のMPUに対する違反
	SYSERR : スレーブ応答エラー

上記の2種類の例外に関しては，HVのユーザープログラムで定義した例外ハンドラを呼び出す．

### MIP/MDP例外ユーザー例外ハンドラ

ホスト定義のMPUに対する違反が発生した場合は以下の例外ハンドラを呼び出す

	void vm_mip_handler(VMEXC_INFO *pVmexcInfo)

pVmexcInfo は発生した例外の例外情報が渡される

### SYSERR例外ユーザー例外ハンドラ

スレーブ応答エラーが発生した場合は以下の例外ハンドラを呼び出す

	void vm_syserr_handler(VMEXC_INFO *pVmexcInfo)

pVmexcInfo は発生した例外の例外情報が渡される

## VMで発生した例外の例外情報（VMEXC_INFO）

それぞれの例外の引数として渡される，VHEXC_INFO  は構造体となっており，そのメンバーはは次の通りである．

    uint32 cause;   /* 例外要因 */
    ID     vmid;    /* VMID */
    uint32 pc;      /* pc */
    uint32 psw;     /* psw */
    uint32 regbase; /* レジスタの保存先のベースアドレス */

regbaseには例外発生時の各種レジスタが保存されている領域であり，以下のオフセットによりアクセス可能である．


|  レジスタ名 |  オフセットマクロ名
| ----------- | ------------------- 
|  FPSR       |  VMEXC_REGBASE_FPSR 
|  R1         |  VMEXC_REGBASE_R1   
|  R2         |  VMEXC_REGBASE_R2   
|  R3(SP)     |  VMEXC_REGBASE_SP   
|  R4         |  VMEXC_REGBASE_R4   
|  R5         |  VMEXC_REGBASE_R5   
|  R6         |  VMEXC_REGBASE_R6   
|  R7         |  VMEXC_REGBASE_R7   
|  R8         |  VMEXC_REGBASE_R8   
|  R9         |  VMEXC_REGBASE_R9   
|  R10        |  VMEXC_REGBASE_R10  
|  R11        |  VMEXC_REGBASE_R11  
|  R12        |  VMEXC_REGBASE_R12  
|  R13        |  VMEXC_REGBASE_R13  
|  R14        |  VMEXC_REGBASE_R14  
|  R15        |  VMEXC_REGBASE_R15  
|  R16        |  VMEXC_REGBASE_R16  
|  R17        |  VMEXC_REGBASE_R17  
|  R18        |  VMEXC_REGBASE_R18  
|  R19        |  VMEXC_REGBASE_R19  
|  R20        |  VMEXC_REGBASE_R20  
|  R21        |  VMEXC_REGBASE_R21  
|  R22        |  VMEXC_REGBASE_R22  
|  R23        |  VMEXC_REGBASE_R23  
|  R24        |  VMEXC_REGBASE_R24  
|  R25        |  VMEXC_REGBASE_R25  
|  R26        |  VMEXC_REGBASE_R26  
|  R27        |  VMEXC_REGBASE_R27  
|  R28        |  VMEXC_REGBASE_R28  
|  R29        |  VMEXC_REGBASE_R29  
|  R30        |  VMEXC_REGBASE_R30  
|  R31        |  VMEXC_REGBASE_R31  


# マルチコア対応

## コアID

各コアを識別するためのIDをコアIDと呼ぶ．コアIDは0から始まり，CPU0のコアIDは0である．

## HVサポートコア

ハイパーバイザーを実行するコアを指定することが可能である．

ハイパーバイザーを実行するコアをHVサポートコアと呼ぶ．

HVサポートコア以外のコアにはハイパーバイザーとは異なるバイナリを配置して実行することを想定する．

HVサポートコア以外のコアでハイパーバイザーが起動した場合はスタートアップコードで無限ループとする．

## シングルVMコア

HVサポートコアは，シングルVMコアに指定することも可能である．

シングルVMコアとしたコアでは，システム周期をサポートせず，1個のタイムウィンドウのみ割り付けることが可能である．

常にこの1個のタイムウィンドウに割り付けた仮想マシンオブジェクトのみを実行する．

タイムウィンドウの長さは無視される．

HVタイムウィンドウ処理やアイドル処理は実行されず，タイムウィンドウ切換え処理やシステム周期切換え処理は実行されない．

![シングルVMコア](./singlevmcore.jpg)

## リーダコア

HVサポートコアのうちの1コアをリーダコアとする．

リーダコアは，電源投入後に起動して，他のHVサポートコアの起動や起動時の共有リソースの初期化等を行う．

### コンフィギュレーション

システム全体で次のパラメータを指定する．

- HVサポートコア
- シングルVMコア(HVサポートコアに含まれている必要がある)
- リーダコア(HVサポートコアに含まれている必要がある)

# 起動シーケンス

起動シーケンスは次の通りである．

ハイパーバイザーは，ユーザーメイン関数から，StartHV()を呼び出すことにより起動する．
<- は他コアもリーダコアと同じ処理を行うことを示す．


| 場所 | リーダコア |  他コア
| ------- | ---------- | ------------------- 
|ターゲット依存のスタートアップ | 他のHVサポートコアの起動  |
|| 自コアのLRAMの初期化 | <-
|| CRAMの初期化              | CRAMの初期化待ち
|ユーザー起動関数 | ユーザー定義の初期化 | <-
|                   | StartHV()の呼び出し | <-
| StartHV()         | バリア同期1 | <-
|| ターゲット依存の初期化 | <-
|| バリア同期2 | <-
|| HVの初期化  | <-
|| TDMAスケジューリングの初期化 | <-
|| HVタイムウィンドウの初期化 | <-
|| HV割込みの初期化 | <-
|| VM間通信モジュールの初期化 | <-
|| バリア同期3 | <-
|| スレーブガードの初期化 | スレーブガードの初期化待ち
|| バリア同期4 | <-
|| システム周期・タイムウィンドウ用のタイマの初期化 | <-
|| バリア同期5 | <-
|| スタートアップフックの呼び出し | <-
|スタートアップフック | ユーザー定義の初期化 | <-
| StartHV()         | バリア同期6 | <-
|| システム周期用のタイマのスタート | <-
|| システム周期割込みの発生 | <-
|| 割込みの許可 | <-
|| TDMAスケジューリングの開始 | <-


# HVコール

HVコールは，仮想マシンからHVサービス関数を呼び出す機能である．

仮想マシンからhvtrapを呼び出すことにより実行される．

各HVサービス関数には機能コードが割り付けられており，hvtrapを呼び出す際に指定する．

HVコールのコーリングコンベンションは次の通りである．

- 機能コード
  - r9
- 引数
  - 第1引数 : r7
  - 第2引数 : r6
  - 第3引数 : r8
- 戻り値
  - 32bit r10
  - 64bit r10,r11
- スクラッチレジスタ
  - r4(tp), r5(gp), r7 - r19,  r30(ep), r31(lp)

HVコールによるHVサービス関数実行中は，HV割込みは禁止される．そのため，タイムウィンドウ切り換え直前に呼び出した場合は，タイムウィンドウ切り換えは遅延する．

HVコールによるHVサービス関数は，実行中のタイムウィンドウのバジェットを消費して実行される．

# ハイパーバイザ動作時のSPIDの扱い

各コアのハイパーバイザー動作時のSPIDはコンフィギュレーションで指定する．

各コアに同じ値を設定することや，異なる値を設定することも可能である．

指定された値は，ハイパーバイザー起動時に各コアで設定する．起動後は同じ値を保持する．

ハイパーバイザーでは起動時以外は，SPIDの設定は行わないため，ユーザーホスト処理でSPIDを変更した場合の動作の動作は保証しない．

## コンフィギュレーション

コア毎に次のパラメータを指定する．

- ハイパーバイザー動作時のSPID
    
# 保護設定

スレーブガートとMPUを使用して次のように保護を行うことを基本とする．

設定は次の2種類を組み合わせで実現する．

 - ハイパーバイザーがコンフィギュレーション情報を元に設定する内容．
 - ハイパーバーサーユーザーが各種フックで設定する内容．

それぞれの項目の先頭の[]は次の意味である．

- Guard
    - スレーブガードによる保護
- MPU
    - MPUによる保護
- INTC1
    - INTC1のGPIDによる保護

## ハイパーバイザーによる設定

- RAM
    - [Guard]全てのRAMを全コアのHVと仮想マシンのSPIDからのみ読み書き可能に設定する．
        - IVCで使用するCRAMの領域は含まない
    - [MPU]仮想マシン毎のメモリのコンフィギュレーションにより、仮想マシン実行時にホスト管理のMPUを設定
- 周辺回路(INTC1以外のCPU周辺回路を含む)
    - [Guard]全ての周辺回路を全てのコアのHVのSPIDからのみ読み書き可能に設定．
- INTC2
    - [Guard]全てのコアのHVのSPIDからのみ読み書き可能に設定．
    - [Guard]仮想マシンにバインドした割込みのEEICは、全コアのHV及びその仮想マシンのSPIDからのみ読み書き可能に設定．
        - コンフィギュレーションにより決定
- INTC1
    - [Guard]他のコアのHVや仮想マシンからの読み書きを禁止する．
    - [INTC1]自コアからのEEICnとIMR0への読み書きは、対応するチャネルがバインドされたGPID、または、ホストモードからのアクセスのみ許可
      - INTC1の機能でありハイパーバイザーによる設定は不要

## ハイパーバイザーユーザーによる設定
- RAM
    - [Guard]DMA等のコア以外のマスタからアクセスする必要があれば設定．
- 周辺回路
    - [Guard]仮想マシンが使用する周辺回路はアクセス可能なようにスレーブガードを設定する．
- INTC2
    - 設定の必要はない
- INTC1
    - 設定の必要なし

# タイムウィンドウトリガ割込み

タイムウィンドウトリガ割込みは，VMタイムウィンドウ及びHVタイムウィンドウの開始時に割込みを発生させる機能である．

タイムウィンドウ毎に1個登録することが可能である．

VMタイムウィンドウではVM割込みとして，HVタイムウィンドウではHV割込みとして発生する．

各タイムウィンドウトリガ割込みはタイムウィンドウ登録時に次の属性で指定する．

- 割込み番号
  - タイムウィンドウトリガ割込みとして発生させる割込みの割込み番号．
  - 使用しないデバイスの割込みを使用することを想定. 
  - VMタイムウィンドウの場合は，割り付けたVMに割り付けた割込みのみ指定可能．
- 発生周期
  - タイムウィンドウトリガ割込みを発生させる周期
  - 1を指定すると毎システム周期発生させる
  - 2を指定すると，システム開始後，2周期目に発生し，これ以降2周期に1回発生させる．

同一VMが属する複数のタイムウィンドウには，同じ割込み番号を指定することも可能である．
その際，発生周期に関してはタイウィンドウ毎に管理される．

![タイムウィンドウトリガ割込み](./twtriggerint.jpg)

## コンフィギュレーション

タイムウィンドウのコンフィギュレーション情報として指定する．

# ユーザーホスト処理向けサービス

## ハイパーバイザーの起動
	void StartHV(SOMID somid)
### パラメータ
	SOMID	somid	システム動作モード
### 機能
呼び出されたコアで，somidで指定されたシステム動作モードでハイパーバイザーの動作を開始する．
ユーザーメイン関数からのみ呼び出し可能である．
HVサポートコア以外から呼び出された場合はリターンする．
somidが不正な場合はID番号1のシステム動作モードとなる．


## HVタイムウィンドウの残り時間取得
	ER ercd = GetHVTWTimeLeft(uint32 *p_time) 
### パラメータ
	uint32 *	pTimeLeft	残り時間を入れるメモリ領域へのポインタ
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
	uint32	pTimeLeft	タイムウィンドウの残り時間
### エラーコード
	E_OK	正常終了
	E_CTX	コンテキストエラー
			HVタイムウィンドウ処理以外からの呼び出し
### 機能
実行中のHVタイムウィンドウの残り時間をマイクロ秒で取得する．
割込みを禁止して呼び出すことが可能である．
HVタイムウィンドウ処理が呼び出した場合，呼び出し直後にタイムウィンドウ切り換えが発生すると，実際の残り時間と異なる値となる可能性があるため，ある程度のマージンを持って使用する必要がある．

## HVアイドル処理からのVMの呼び出し
	ER ercd = CallIdleVM(ID vmid) 
### パラメータ
	ID		vmid	呼び出すVMのID
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK	正常終了
	E_ID	vmidで指定したVMが存在しない
	E_OBJ	vmidで指定したVMが異なるコアに割り付けられている
	E_CTX	コンテキストエラー
			HVアイドル処理以外からの呼び出し
### 機能
vmidで指定したVMをアイドル区間で実行する．
指定可能なVMは同じ呼び出したHVアイドル処理と同じコアに割り付けられているもののみ指定可能．
HVアイドル処理からのみ呼び出し可能．
次のシステム周期でHVアイドル処理が実行されるとこのサービコールからリターンする．

## VMのリセット
	ER ercd = ResetVM(ID vmid, uint32_t arg1, uint32_t arg2, uint32_t arg3, uint32_t arg4) 
### パラメータ
	ID			vmid	リセットするVMのID
	uint32_t 	arg1 	VMへの第1引数
	uint32_t 	arg2 	VMへの第2引数
	uint32_t 	arg3 	VMへの第3引数
	uint32_t 	arg4 	VMへの第4引数
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK	正常終了
	E_ID	vmidで指定したVMが存在しない
	E_CTX	コンテキストエラー
			HV割込みハンドラ/HVタイムウィンドウ処理/HVアイドル処理/HVフック関数/スタートアップコード
			以外からの呼び出し．
### 機能
vmidで指定したVMをリセットする．
リセットと同様にPSWをセットして，登録されたRBASEから実行するよう設定する．
arg1からarg4に指定された値は，リセット時のVMのR5からR9に設定される．
リセットの要因を伝えるために使用することを想定している．
最初の起動の値は全て0である．
変更したい場合は，スタートアップコードから本サービスコールを呼び出すこと．
	
## VM疑似例外生成API(FE例外)
### ER ercd = RaiseVMFakeFE(ID vmid, uint32_t voffset, uint32_t cause) 
### パラメータ
	ID			vmid	VM疑似例外を送るVMのID
	uint32_t 	voffset	実行するアドレスのRBASEからのオフセット
	uint32_t 	cause 	例外要因レジスタ(feic)に設定する値
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK	正常終了
	E_ID	vmidで指定したVMが存在しない
	E_CTX	コンテキストエラー
			HV割込みハンドラ/HVタイムウィンドウ処理/HVアイドル処理/HVフック関数	以外からの呼び出し．
### 機能
vmidで指定したVMに擬似例外(FE)例外を送る．
VMの状態をFE例外発生時と同じ状態として，RBASE + voffsetの番地から実行するよう設定する．
設定するレジスタはpsw，pc，feicである．pswについてはNPビットを設定する．
feicにはcauseで指定した値が設定される．

## VM疑似例外生成API(EI例外)
	ER ercd = RaiseVMFakeEI(ID vmid, uint32_t voffset, uint32_t cause) 
### パラメータ
	ID			vmid	VM疑似例外を送るVMのID
	uint32_t 	voffset	実行するアドレスのRBASEからのオフセット
	uint32_t 	cause 	例外要因レジスタ(eiic)に設定する値
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK	正常終了
	E_ID	vmidで指定したVMが存在しない
	E_CTX	コンテキストエラー
			HV割込みハンドラ/HVタイムウィンドウ処理/HVアイドル処理/HVフック関数	以外からの呼び出し．
### 機能
vmidで指定したVMに擬似例外(EI)例外を送る．
VMの状態をEI例外発生時と同じ状態として，RBASE + voffsetの番地から実行するよう設定する．
設定するレジスタはpsw，pc，eiicである．pswについてはIDビットを設定する．
eiicにはcauseで指定した値が設定される．

## システム動作モードの変更
	ER ercd = ChangeSystemOperationMode(ID somid)
### パラメータ
	ID			somid	切り替え先のシステム動作モードのID
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK	正常終了
	E_ID	somidで指定したシステム動作モードが存在しない
### 機能
次のシステム周期開始時にsomidで指定したシステム動作モードに現在のシステム動作モードを変更するよう指定する．

ChangeSystemOperationMode()を実行しているコアが，一時的に切換え前のシステム動作モードで実行している状況では，somidで指定したシステム動作モードに切り換わるのは，切換え後のシステム周期の終了後になる．

## システム動作モードの参照
	ER ercd = GetSystemOperationMode(ID *p_somid)
### パラメータ
	ID			p_somid	現在のシステム動作モードのID番号を入れるメモリ領域へのポインタ

### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK	正常終了
### 機能
現在のシステム動作モードを参照する．

GetSystemOperationMode()を実行しているコアが，一時的に切換え前のシステム動作モードで実行している状況では，p_somidで指すメモリ領域に返されるのは，切換え後のシステム動作モードにな


# ゲスト処理向けサービス

## VMタイムウィンドウの残り時間取得
	ER ercd = GetVMTWTimeLeft(uint32 *pTimeLeft)
### パラメータ
	uint32 *	pTimeLeft	残り時間を入れるメモリ領域へのポインタ
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
	uint32	pTimeLeft	タイムウィンドウの残り時間
### エラーコード
	E_OK	正常終了
### 機能
実行中のVMタイムウィンドウの残り時間をマイクロ秒で取得する．
呼び出し直後にタイムウィンドウ切り換えが発生すると，実際の残り時間と異なる値となる可能性があるため，ある程度のマージンを持って使用する必要がある．
割込みを禁止して呼び出すことが可能である．
ライブラリ関数として仮想マシン内で実行される．

# VM間通信機能

VM間通信機能はHVコールを用いて呼び出す．

## 状態変数

1：n向けのキューイングなしの通信を実現．
オブジェクトはIDにより識別する．
書き込み可能な仮想マシンは指定した特定の1つのVMのみ．
読み込み可能な仮想マシンには制限はない．
ハイパーバイザーは制限なしに読み書き可能．

## コンフィギュレーション

オブジェクト毎に次のパラメータを指定する．

	- 状態変数オブジェクトのバッファサイズ（バイト指定）
	- 初期状態 : アクティブ/ディアクティブ
        - アクティブ/ディアクティブをサポートしないなら初期値を設定する
	- 書き込み可能な仮想マシン

状態変数オブジェクトのバッファサイズが大きくなると，状態変数関連のサービスの実行時間が長くなる．
サービス実行中はタイムウィンドウ切り換えが発生しないため，許容するタイムウィンドウのジッタによりシステムインテグレータが決定する．

## 状態変数オブジェクトへのデータ書き込み

	ER ercd = WriteStateVariable(uint SvarID, const void* Variable)

### パラメータ
	uint		SvarID 		対象状態変数のID
	const void*	Variable 	書込みデータの格納先の先頭番地
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_MACV		Variableで示す領域が不正
	E_OACV		書き込み許可されていないVMからの呼び出し
### 機能
SvarIDで示す状態変数オブジェクトのバッファに対して，Variableで示すアドレスから対象状態変数オブジェクトのサイズ分のデータを書き込む．
Variableの示すアドレスから対象状態変数オブジェクトのサイズ分のメモリが，本APIを呼び出した仮想マシンから読み込み出来ない領域の場合は，エラーを返す．
状態変数オブジェクトの状態がディアクティブの場合はアクティブになる．
書き込みが許可されていない仮想マシンからの呼び出しであればエラーとなる．

## 状態変数オブジェクトからのデータ読み込み

	ER ercd = ReadStateVariable(uint SvarID, void *Variabale)

### パラメータ
	uint	SvarID		対象状態変数のID
	void*	Variable	読込みデータの格納先の先頭番地
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_MACV		Variableで示す領域が不正
	E_OBJ		状態変数オブジェクトの状態がディアクティブ
### 機能

SvarIDで示す状態変数オブジェクトのバッファから，Variableで示すアドレスに対して対象状態変数オブジェクトのサイズ分のデータを書き込む．
Variableの示すアドレスから状態変数のサイズ分のメモリが，本APIを呼び出した仮想マシンから書き込み出来ない領域の場合は，エラーを返す．
状態変数オブジェクトの状態がディアクティブの場合はエラーを返す．

## 状態変数オブジェクトの状態をディアクティブに変更

	ER ercd = DeactivateStateVariable(uint SvarID)

### パラメータ
	uint	SvarID		対象状態変数のID
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_OACV		書き込み許可されていないVMからの呼び出し
### 機能
SvarIDで示す状態変数オブジェクトの状態をディアクティブに変更する．
書き込みが許可されていない仮想マシンから呼び出された場合はエラーとなる．

## メッセージキュー

1:1のキューイング通信をサポートする．
メッセージは最大長が設定されていて，それ以下の任意のサイズで送信可能である．
メッセージサイズは保存され，受信側はそのサイズ分受け取る．
オブジェクトはIDにより識別する．
書き込み可能なVMは1つのみ．
読み込み可能なVMは1つのみ．
バッファはメッセージを格納する毎に次のように使用されるために実際格納可能なサイズは小さくなる

- 4バイトの管理領域(サイズ情報)  + メッセージサイズを4バイトに丸めた値 

## コンフィギュレーション
オブジェクト毎に次のパラメータを指定する．

- 最大メッセージサイズ
	 - 許容するタイムウィンドウのジッタによりシステムインテグレータが決定する．
- バッファサイズ（バイト）
- 初期状態 : アクティブまたはディアクティブ
- 書き込み可能な仮想マシン
- 読み込み可能な仮想マシン

## メッセーキューオブジェクトへのメッセージ書込み
	ER ercd = WriteMessageQueue(uint MsgqID, const void *Message, uint MsgSize)
### パラメータ
	uint 		MsgqID  	対象メッセージキューのID
	const void*	Message 	書き込むメッセージの先頭アドレス
	uint 		MsgSize		書き込むメッセージのサイズ（バイト数）
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_MACV		Messageで示す領域が不正
	E_OACV		書き込み許可されていないVMからの呼び出し
	E_BUF		バッファがフル
	E_PAR		MsgSizeがメッセージの最大サイズより大きい
### 機能
MsqIDで示すメッセーキューオブジェクトに対して，Messageで示すアドレスからMsgSize分のデータを書き込む．
MsgSizeの示すアドレスからMsgSizeサイズ分のメモリが，本APIを呼び出した仮想マシンから読み込み出来ない領域の場合は，エラーを返す．
メッセーキューオブジェクトの状態がディアクティブの場合はアクティブになる．
書き込みが許可されていない仮想マシンから呼び出された場合はエラーとなる．
バッファにMsgSize分の空きがない場合はエラーとなる．

## メッセーキューオブジェクトからメッセージの読込み
	int MsgSize = ReadMmessageQueue(uint MsgqID, void *Message)
### パラメータ
	uint 	MsgqID  	対象メッセージキューのID
	void*	Message 	メッセージを格納する先頭アドレス
### リターンパラメータ
	ER		MsgSize		受信メッセージサイズ（正の値）またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_MACV		Messageで示す領域が不正
	E_OBJ		オブジェクトの状態がディアクティブ
	E_OACV		読み込みが許可されていないVMからの呼び出し
	E_BUF		バッファがエンプティ
### 機能
MsgqID示すメッセージキューオブジェクトから，Messageで示すアドレスにメッセージを読み込む．
Messageの示すアドレスからメッセージキューのサイズ分のメモリが，本APIを呼び出した仮想マシンから書き込み出来ない領域の場合はエラーとなる．
メッセージキューオブジェクトの状態がディアクティブの場合はエラーとなる．
バッファにメッセージがない場合はエラーとなる．

## メッセージキューオブジェクトの状態をディアクティブに変更
	ER ercd = DeactivateMessageQueue(int MsgqID)
### パラメータ
	uint 		MsgqID  	対象メッセージキューのID
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_OACV		書き込み許可されていない仮想マシンからの呼び出し
### 機能
MsgqIDで示すメッセージキューオブジェクトの状態をディアクティブに変更する．
キューイングされているメッセージは全て削除される．
書き込みが許可されていない仮想マシンから呼び出された場合はエラーとなる．

# 共有バッファ

MPUを用いたn対nの通信をサポートする．
HVコールでバッファを取得する．取得したバッファには直接アクセス可能である．
アクセス後，バッファを解放する．
バッファへ同時アクセス可能性VMは1個のみである．
アクセス権がない状態では，バッファへの読み書きは出来ない．

## コンフィギュレーション
オブジェクト毎に次のパラメータを指定する．
 - バッファサイズ
	- 256byteからCRAMのサイズまで指定可能
 - アクセスする仮想マシン(N個)
 
## アクセス権の取得
	ER ercd = AcquireSharedBuffer(uint SBufID, void **BufPtr)
### パラメータ
	uint 		SBufID		対象共有バッファのID
	void**		BufPtr		バッファのポインタ
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_OBJ		アクセス権の取得失敗
### 機能
SBufIDで示す共有バッファのアクセス権を取得する．
取得に成功した場合，共有バッファの状態はロックとなり，他のVMはアクセス権を取得できない．

## アクセス権の返却
	ER ercd = ReleaseSharedBuffer(uint SBufID)
### パラメータ
	uint 		SBufID		対象共有バッファのID
### リターンパラメータ
	ER		ercd		正常終了(E_OK)またはエラーコード
### エラーコード
	E_OK		正常終了
	E_ID		ID番号が不正
	E_OBJ		アクセス権の返却失敗
### 機能
SBufIDで示す共有バッファのアクセス権を返却する．
アクセス権を取得してない場合はエラーを返す．

# 更新履歴
- 2023/12/19
	- システム動作モードの導入．
	
- 2023/03/20
	- HVアイドル処理からのVM呼び出し機能を追加．
	- 例外処理機能を追加．

- 2022/07/28  最初のリリース

以上．
